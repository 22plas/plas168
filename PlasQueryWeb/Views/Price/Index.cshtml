@{ViewBag.Title = "塑料和弹性体-价格走势"; }
@{
    var type = (ViewBag.ProductType) as System.Data.DataTable;
    var company = (ViewBag.company) as System.Data.DataTable;
}
<link href="~/Content/css/Pagination.css" rel="stylesheet" />
<script src="~/Content/layui/lay/modules/layer.js" type="text/javascript"></script>
<script src="~/Scripts/jquery.pagination.js" type="text/javascript"></script>
<style type="text/css">
    .current {
        display:none !important;
    }
    .page .disabled {
        margin-right:10px;
    }
    span:nth-child(1) {
        margin-right: 20px;
    }
        .item-right {
            width: 76%;
            text-align: left;
            background-color: #fff;
            border: 1px solid #ddd;
            padding: 0;
        }

    .item-left {
        width: 22%;
        padding: 0;
        background-color: #fff;
        border: 1px solid #ddd;
    }

        .item-left li {
            display: flex;
            width: 100%;
            padding: 8px 10px;
            border-bottom: 1px solid #ddd;
            box-sizing: border-box;
        }

            .item-left li > .right {
                min-width: 100px;
                max-width: 100px;
                text-align: center;
            }

            .item-left li > .left {
                width: calc(100% - 85px);
                overflow: hidden;
                white-space: nowrap;
                text-overflow: ellipsis;
                margin-right: 10px;
            }

            .item-left li p {
                line-height: 25px;
            }

            .item-left li .right {
                float: right;
                line-height: 25px;
            }

            .item-left li.active {
                background-color: #14a5ef;
                color: #fff;
            }

                .item-left li.active span {
                    color: #fff !important;
                }

            .item-left li.page {
                padding: 5px 10px;
            }

                .item-left li.page span {
                    margin-left: 10px;
                    cursor: pointer;
                }

    .item-right .footer {
        background-color: #f1fdfc;
        font-size: 12px;
        color: #d4716e;
        padding-top: 5px;
        padding-bottom: 5px;
        line-height: 18px;
        border-top: 1px #e4f1f3 solid;
    }

    .item-right div {
        padding: 0 15px;
        box-sizing: border-box;
    }

    .item-right .title {
        display: inline-block;
        font-size: 16px;
        font-weight: bold;
        margin-top: 10px;
    }

    .item-right .right {
        display: inline-block;
        float: right;
    }

    .item-right .day {
        border: 1px solid #ddd;
        border-radius: 20px;
        padding: 0;
    }

        .item-right .day span {
            display: inline-block;
            padding: 0 8px;
            cursor: pointer;
        }

            .item-right .day span.left {
                border-top-left-radius: 20px;
                border-bottom-left-radius: 20px;
            }

            .item-right .day span.right {
                border-top-right-radius: 20px;
                border-bottom-right-radius: 20px;
            }

            .item-right .day span.active {
                background-color: #5ab55a;
                color: #fff;
            }
    .input {
        width: 100px;
        height: 26px;
    }

</style>
<link href="~/Content/css/H-ui.min.css" rel="stylesheet" />

@Html.Partial("~/Views/Public/SubPageNav.cshtml")

@{
    Html.RenderAction("PubSearch", "Public");
}

<div class="search-item-box">
    <div class="search-item">
        <div class="search-item-type">材料类别：</div>
        <div class="search-item-content">
            <ul class="search-item-content" data-type="1" data-typename="材料类别">
                <li data-guid="" data-value="0" class="active">全部</li>
                @for (var i = 0; i < type.Rows.Count; i++)
                {
                    <li data-guid="" data-value="@type.Rows[i]["Name"].ToString()">@type.Rows[i]["Name"].ToString()</li>
                }
            </ul>
        </div>
        <div class="search-item-btn" data-type="1" data-typename="材料类别">更多 ∨</div>
    </div>
    <div class="search-item">
        <div class="search-item-type">厂家选择：</div>
        <div class="search-item-content">
            <ul class="search-item-content" data-type="4" data-typename="生产厂家">
                <li data-guid="" data-value="0" class="active">全部</li>
                @for (var i = 0; i < company.Rows.Count; i++)
                {
                    <li data-guid="" data-value="@company.Rows[i]["Name"].ToString()">@company.Rows[i]["Name"].ToString()</li>
                }
            </ul>
        </div>
        <div class="search-item-btn" data-type="4" data-typename="生产厂家">更多 ∨</div>
    </div>
</div>
<p style="padding: 10px 20px;" id="selectCheckValue">
    当前已选择条件：<span class="search_condition_wrap">
    </span>
            <button id="shartPrice" class="btn btn-warning radius size-S" type="button">←搜索</button>
</p>
<div class="marginTop" style="margin-top: 0;padding-top: 0;">
    <div class="item-left">
        <ul id="PriceListHTML"></ul>
        <ul>
            <li class="page" id="Pagination">
                <span>上一页</span><span>下一页</span>
            </li>
        </ul>
    </div>
    <div class="item-right">
        <div>
            <span class="title">价格趋势</span>
            <div class="right" style="padding-top: 7px;">
                <span>开始时间：</span><input type="text" id="beginDate" onkeyup="DateVerification('beginDate');" class="input">
                <span style="margin-left: 8px;">结束时间：</span>
                <input type="text" id="endDate" onkeyup="DateVerification('endDate');"  class="input">
                <button id="shartPrice" class="btn btn-warning radius size-S" type="button">查询</button>
                <!--<a class="btn btn-red" style="margin-left: 5px;">查询</a>-->
            </div>
        </div>
        <div>
            <span class="Txt_SmallClass"></span> | <span class="Txt_Model"></span>
        </div>
        <div style="color: #777;border-bottom: 1px solid #ddd;padding-bottom: 8px">
            <span class="fa fa-check-square"></span>加入价格对比 <span class="fa fa-square" style="margin-left: 15px;"></span>显示上游原料价格
            <a style="margin-left: 15px;color:#0098dc;" href="javascript:void(0)">查看物价表</a>
            <div class="right">
                <div class="day">
                    <span class="left active" Number="7" style="border-right: 1px solid #ddd;">近七天</span><span style="border-right: 1px solid #ddd;" Number="30">近一月</span><span class="right" Number="180">近半年</span>
                </div>
            </div>
        </div>
        <div id="chart1" style="height: 419px;width: 100%;">

        </div>
        <div style="text-align: center;">
            <span>牌号：<span class="Txt_SmallClass"></span></span><span>厂家：<span class="Txt_Manufacturer"></span></span>
        </div>
        <div class="footer">
            免责声明：参考价格是塑料网根据网络大数据分析的结果，仅供参考，实际成交价取决但不限于以下因素：下单时间、交货方式、付款方式、数量、税费、色号、产地、项目信息等。
        </div>
    </div>
</div>
<script src="~/Content/js/echarts.min.js"></script>
<script type="text/javascript">
    var pagesize = 8;
    var rowcount = 0;
    var datas = "";
    var page_indx = 0;
    var strcount = 0;

    var dataArry = new Array();//时间
    var priceArry = new Array();//价格

    var SmallClass = "";
    var Manufacturer = "";
    var Model = "";
    var priceData = "";
    function NoneLine() {
        if ($("#Pagination").find("span").length > 0) {
            $.each($("#Pagination").find("span"), function (index, item) {
                if ($(this).html().indexOf("...") > -1) {
                    $(this).remove();
                }
            })
        }
    }

    $(function () {
        $(".navBox").find(".nav").find("li").eq(1).children("a").addClass("active");
        NoneLine();
        //修改时间格式
    })
    ///点击更多
    $(".search-item-btn").click(function () {
        var dataval = $(this).attr("data-type");
        var datatile = $(this).attr("data-typename");
        layer.open({
            type: 2,
            title: 'MORE-' + datatile,
            shadeClose: true,
            shade: 0.8,
            maxmin: true,
            area: ['90%', '90%'],
            content: '/PhysicalProducts/More?rid=' + dataval + "&rname=" + datatile + "&more=1"
        });
    })


    ///选中值，只能单选
    $(".search-item-content").find("li").click(function () {
        var dataname = $(this).parent().attr("data-typename");//名称
        var datatype = $(this).parent().attr("data-type");//类型
        var dataval = $(this).attr("data-value");
        var str = "";
        var istrue = false;
        ///添加样式
        if (dataval == "0") {
            $.each($("ul[data-type='" + datatype + "']").find("li"), function (index, item) {
                $(this).removeClass("active");
            })
            $("ul[data-type='" + datatype + "']").find("li").eq(0).addClass("active");
            ///删除条件同类条件
            $(".search_condition_wrap").find("span[datatype='" + datatype + "']").remove();
        }
        else {
            $("ul[data-type='" + datatype + "']").find("li").removeClass("active");
            $(this).removeClass("active").addClass("active");
            //首次添加
            $(".search_condition_wrap").find("span[datatype='" + datatype + "']").remove();
            str = '<span class="search-select-item" title="' + dataval + '"  datatype="' + datatype + '" bigTitle="' + dataname + '">' + dataname + ':' + dataval + '<span class="fa fa-close" title="删除"></span></span>'
            $(".search_condition_wrap").append(str);
            ///删除已经选择的
            $(".fa-close").click(function () {
                //alert($(this).parent().html());
                $(this).parent().remove();
            })


        }

    })




    $().ready(function () {
        InitData(0);
    });



    function InitData(pageindx) {
        page_indx = pageindx;
        var tbodyui = "";
        $.ajax({
            type: "POST",
            dataType: "JSON",
            url: '/Price/GetPriceList',
            data: "pageindex=" + (pageindx + 1) + "&pagesize=" + pagesize + datas,
            async: false,
            success: function (json) {
                // debugger;
                var productData = json.data;
                rowcount = json.totalCount;
                if (rowcount != 0) {
                    $.each(JSON.parse(productData), function (i, n) {
                        strcount++;
                        tbodyui += '<li';
                        if (strcount == 1) {
                            tbodyui += ' class="active"';
                            SmallClass = n.SmallClass;
                            Manufacturer = n.ManuFacturer;
                            Model = n.Model;
                            priceData="&priceDate=7"
                            GetPriceList();
                            onLoadEchars();
                        }
                        tbodyui += ' style="cursor: pointer" smallClass="' + n.SmallClass + '" manufacturer="' + n.ManuFacturer + '"  model="' + n.Model+'">';
                        tbodyui += '<div class="left">';
                        tbodyui += '<p>' + n.SmallClass + ' | ' + n.ManuFacturer + '</p>';
                        tbodyui += '<p>' + n.Model + '</p>';
                        tbodyui += '</div>';
                        tbodyui += ' <div class="right">';
                        tbodyui += ' <p>' + n.Price + '元/吨</p>';//  
                        tbodyui += '<p><span class="fa';
                        if (parseInt(n.Diff) > 0) 
                            tbodyui += ' fa-arrow-up text-red';
                        else
                            tbodyui += ' fa-arrow-down text-green';
                        tbodyui += '" style = "margin-left: 8px;" ></span >';
                        tbodyui += '<span class="text-red">' + n.Diff + '</span>';
                        tbodyui += '</p> </div > </li >';

                    });
                }
                $("#PriceListHTML").html(tbodyui);

            },
            error: function () { layer.msg('Load the data failure!', { icon: 5 }); }
        });

        $("#Pagination").pagination(rowcount, {
            callback: pageselectCallback,
            prev_text: '上一页',
            next_text: '下一页',
            items_per_page: pagesize,
            num_display_entries: 0,
            current_page: pageindx,
            num_edge_entries: 1
        });

        NoneLine();

        //点击选中
        $("#PriceListHTML").find("li").click(function () {
            $.each($("#PriceListHTML").find("li"), function (index, item) {
                $(this).removeClass("active");
            })
            $(this).addClass("active");
            SmallClass = $(this).attr("smallclass");
            Manufacturer = $(this).attr("manufacturer");
            Model = $(this).attr("model");
            GetPriceList();
            onLoadEchars();

        })


    }

    function pageselectCallback(page_id, jq) {

        InitData(page_id);
    }

    //搜索
    $("#shartPrice").click(function () {
        var strwhere = "";
        var strmodel = "";
        if ($(".search_condition_wrap").find("span[datatype='4']").length > 0) {
            strwhere = '&Manufacturer=' + $(".search_condition_wrap").find("span[datatype='4']").attr("title");
        }

        if ($(".search_condition_wrap").find("span[datatype='1']").length > 0) {
            strmodel = '&Model=' + $(".search_condition_wrap").find("span[datatype='1']").attr("title");
        }
        datas = strwhere + strmodel;
        InitData(0);
    })






    function GetPriceList() {
        //debugger;
        //SmallClass='ABS' and Manufacturer='台湾台化' and Model='AG15A1'  
        dataArry.length = 0;
        priceArry.length = 0;
        $(".Txt_SmallClass").html(SmallClass);
        $(".Txt_Manufacturer").html(Manufacturer);
        $(".Txt_Model").html(Model);
        $.ajax({
            type: "POST",
            dataType: "JSON",
            url: '/Price/GetPriceDateList',
            data: "SmallClass=" + SmallClass + "&Manufacturer=" + Manufacturer + "&Model=" + Model + priceData,
            async: false,
            success: function (result) {
               // debugger;
                var product_Data = result.data;
                row_count = result.totalCount;
                if (row_count != 0) {
                    $.each(JSON.parse(product_Data), function (a, b) {
                        dataArry.push(getdatefroment(b.PriDate)); //PriDate formatterTime(b.PriDate, "YYYY-MM-DD")
                        priceArry.push(parseInt(b.Price));
                    });
                }
                //dataArry = dataArry.substring(0, dataArry.length - 1);
                //priceArry = priceArry.substring(0, priceArry.length - 1);
            },
            error: function () { layer.msg('Load the data failure!', { icon: 5 }); }
        });
    }


    ///点击近几天的时间
    $(".day").find("span").click(function () {
        var day = $(this).attr("number");
        $.each($(".day").find("span"), function (index, item) {
            $(this).removeClass("active");
        })
        $(this).addClass("active");
        priceData = "&priceDate=" + day
        GetPriceList();
        onLoadEchars();
    })





</script>
<script type="text/javascript">
    function onLoadEchars() {
        //'2019-03-16', '2019-03-17', '2019-03-18', '2019-03-19'
        var options = {
            title: {
                text: ''
            },
            tooltip: {
                trigger: 'axis',
                axisPointer: {
                    type: 'cross',
                    label: {
                        backgroundColor: '#6a7985'
                    }
                }
            },
            legend: { data: [] },
            toolbox: {
                feature: {
                    saveAsImage: {}
                }
            },
            grid: {
                left: '3%',
                right: '3%',
                bottom: '4%',
                top: '7%',
                containLabel: true
            },
            xAxis: [
                {
                    type: 'category',
                    boundaryGap: false,
                    data: dataArry//'2019-03-16', '2019-03-17', '2019-03-18', '2019-03-19', '2019-03-20', '2019-03-21', '2019-03-22'
                }
            ],
            yAxis: [
                {
                    type: 'value'
                }
            ],
            series: [
                {
                    name: '价格',
                    type: 'line',
                    data: priceArry//
                }
            ]
        };
        function rpt1(id, option, h) {
            var o = document.getElementById(id);
            var myChart = echarts.init(o);
            myChart.setOption(option);
        }
        //alert(dataArry)
        //alert(priceArry)
        rpt1('chart1', options);
    }
    //var dataArry = new Array()
    //dataArry.push("2019-03-16");
    //dataArry.push("2019-03-17");
 
   
</script>

@Html.Partial("~/Views/Public/Bottom.cshtml")